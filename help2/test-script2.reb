

test-obj: [spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D3535594D5A6A346A773035633B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A303920474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A303920474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
303920474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363633302C2273796E63223A313337373639343734392C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D353455376D7A5362505579783B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A313320474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A313320474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
313220474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363633312C2273796E63223A313337373639343735332C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D3932446A6A52724A796B65783B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A313520474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A313520474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
313420474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363633322C2273796E63223A313337373639343735352C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D47386152746839414D3047753B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A313720474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A313720474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
313720474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363633322C2273796E63223A313337373639343735372C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D5076426C7669524839304B363B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A323020474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A323020474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
313920474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363633332C2273796E63223A313337373639343736302C22
6D73223A327D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D447152614E383934774532753B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A323220474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A323220474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
323120474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363633332C2273796E63223A313337373639343736322C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D4E3533434E714732686B75683B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A323420474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A323420474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
323320474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363633332C2273796E63223A313337373639343736342C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D673548784E59394A6C3069783B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A323620474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A323620474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
323520474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363633342C2273796E63223A313337373639343736362C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D4F4C304B796C4C32454565783B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A323820474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A323820474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
323720474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363633372C2273796E63223A313337373639343736382C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D3838703153776A6E6B6566393B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A333020474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A333020474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
333020474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363633372C2273796E63223A313337373639343737302C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D614E65426F643245583057693B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A333320474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A333320474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
333220474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363633372C2273796E63223A313337373639343737332C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D783235315A475A41594571453B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A333520474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A333520474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
333420474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363633372C2273796E63223A313337373639343737352C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D41506566646C374E625574383B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A333720474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A333720474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
333620474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363633392C2273796E63223A313337373639343737372C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D72305977556C7776754569643B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A333920474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A333920474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
333820474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363634322C2273796E63223A313337373639343737392C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D54664B414F707965453654483B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A343120474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A343120474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
343020474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363634322C2273796E63223A313337373639343738312C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D4756443266544E37556C77313B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A343320474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A343320474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
343320474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363634332C2273796E63223A313337373639343738332C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D5657586249484949416B71663B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A343620474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A343620474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
343520474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363634332C2273796E63223A313337373639343738362C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D6E5544775836796F3445796C3B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A343820474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A343820474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
343720474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363634332C2273796E63223A313337373639343738382C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D6555307373536D774B3075363B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A353020474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A353020474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
343920474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363634342C2273796E63223A313337373639343739302C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D62645464675049436C6B6D683B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A353220474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A353220474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
353120474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363634352C2273796E63223A313337373639343739322C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D7A525755736B334B76456D683B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A353420474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A353420474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
353320474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363634382C2273796E63223A313337373639343739342C22
6D73223A327D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D6C58333079493353343065643B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A353720474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A353720474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
353620474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363634392C2273796E63223A313337373639343739372C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D517175534B677035506B43763B20657870697265733D
4672692C2032382D4665622D323031342031323A35393A353920474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35393A353920474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35393A
353820474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363634392C2273796E63223A313337373639343739392C22
6D73223A337D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D51534551686970786B3053393B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A303120474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A303120474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
303020474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363634392C2273796E63223A313337373639343830312C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D3675526E644958494F306D513B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A303320474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A303320474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
303220474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330380D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363635312C2273796E63223A313337373639343830332C22
6D73223A31367D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D7732566D32556171745553663B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A303520474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A303520474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
303420474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363635312C2273796E63223A313337373639343830352C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D414B365A646F696B6B7875713B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A303820474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A303820474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
303720474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363635322C2273796E63223A313337373639343830382C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D6662534E65373037596B53503B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A313020474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A313020474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
303920474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363635352C2273796E63223A313337373639343831302C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D7762446D473234435A4579393B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A313220474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A313220474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
313120474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363635352C2273796E63223A313337373639343831322C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D6B676A396273465130306D753B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A313420474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A313420474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
313320474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363635362C2273796E63223A313337373639343831342C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D47544F616B6A4767695557793B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A313620474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A313620474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
313520474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363635382C2273796E63223A313337373639343831362C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D6873556F7655697A4530576A3B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A313820474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A313820474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
313820474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363636302C2273796E63223A313337373639343831382C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D676A6F325641544D646B48583B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A323120474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A323120474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
323020474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363636342C2273796E63223A313337373639343832312C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D7934775A5170366D654555723B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A323320474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A323320474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
323220474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363636352C2273796E63223A313337373639343832332C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D326E676930453765436B4B433B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A323520474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A323520474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
323420474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363636352C2273796E63223A313337373639343832352C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D4A37694966345574346B69483B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A323720474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A323720474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
323620474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363636362C2273796E63223A313337373639343832372C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D7662335564446C3147556D6E3B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A323920474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A323920474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
323820474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363636392C2273796E63223A313337373639343832392C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D536456697A4B7375425565613B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A333220474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A333220474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
333120474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363636392C2273796E63223A313337373639343833322C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D44396C7A744C6B4948304F493B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A333420474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A333420474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
333320474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363637312C2273796E63223A313337373639343833342C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D336135554237495A354561523B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A333620474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A333620474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
333520474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363637332C2273796E63223A313337373639343833362C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D676A456C41697246307834313B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A333820474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A333820474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
333720474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363637352C2273796E63223A313337373639343833382C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D4457734751533637554744783B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A343020474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A343020474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
333920474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363637352C2273796E63223A313337373639343834302C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D344B38496A74796B327432513B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A343220474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A343220474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
343220474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363637372C2273796E63223A313337373639343834322C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D3442753453576243556D73763B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A343520474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A343520474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
343420474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363637382C2273796E63223A313337373639343834352C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D4F534B734D693146496B534F3B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A343720474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A343720474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
343620474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363637392C2273796E63223A313337373639343834372C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D795A4D7743553138557965443B20657870697265733D
4672692C2032382D4665622D323031342031333A30303A353120474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031333A30303A353120474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031333A30303A
353020474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363638312C2273796E63223A313337373639343835312C22
6D73223A307D
}-=-=-=-=-=-=-=-=-=-=-=-COMPLETE 
Finished Loop 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D686759516231316745794A563B20657870697265733D
4672692C2032382D4665622D323031342031323A35373A333620474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35373A333620474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35373A
333620474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363535302C2273796E63223A313337373639343635362C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D5152645675327637307938723B20657870697265733D
4672692C2032382D4665622D323031342031323A35373A333920474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35373A333920474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35373A
333820474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363535312C2273796E63223A313337373639343635392C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D366856395546496A324569683B20657870697265733D
4672692C2032382D4665622D323031342031323A35373A343120474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35373A343120474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35373A
343020474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363535322C2273796E63223A313337373639343636312C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D6D6C7655314179526F6B57663B20657870697265733D
4672692C2032382D4665622D323031342031323A35373A343320474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35373A343320474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35373A
343220474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363535332C2273796E63223A313337373639343636332C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D6C6A72494B6F3277306D76363B20657870697265733D
4672692C2032382D4665622D323031342031323A35373A343520474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35373A343520474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35373A
343420474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363536342C2273796E63223A313337373639343636352C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D4C5131624E585567383053413B20657870697265733D
4672692C2032382D4665622D323031342031323A35373A343720474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35373A343720474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35373A
343720474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363536352C2273796E63223A313337373639343636372C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D5A6A49356B517257553277643B20657870697265733D
4672692C2032382D4665622D323031342031323A35373A353020474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35373A353020474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35373A
343920474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363536352C2273796E63223A313337373639343637302C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D6F4F616C526F43726B6576703B20657870697265733D
4672692C2032382D4665622D323031342031323A35373A353220474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35373A353220474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35373A
353120474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363536362C2273796E63223A313337373639343637322C22
6D73223A327D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D6250346E575A7148306D45323B20657870697265733D
4672692C2032382D4665622D323031342031323A35373A353420474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35373A353420474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35373A
353320474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330380D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363536372C2273796E63223A313337373639343637342C22
6D73223A34387D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D59545A396C4878326B4B5A343B20657870697265733D
4672692C2032382D4665622D323031342031323A35373A353620474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35373A353620474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35373A
353620474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363537322C2273796E63223A313337373639343637362C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D3034364A4E786371304342763B20657870697265733D
4672692C2032382D4665622D323031342031323A35373A353920474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35373A353920474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35373A
353820474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363537322C2273796E63223A313337373639343637392C22
6D73223A347D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D6D795741776159655330757A3B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A303120474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A303120474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
303020474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363537322C2273796E63223A313337373639343638312C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D76684D6D6D56754C563071313B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A303320474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A303320474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
303220474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363537322C2273796E63223A313337373639343638332C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D684A62456672354F4D4536743B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A303520474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A303520474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
303420474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363537322C2273796E63223A313337373639343638352C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D6675544561334462764575413B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A303720474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A303720474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
303720474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363537332C2273796E63223A313337373639343638372C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D4357676230526535656B494F3B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A313020474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A313020474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
303920474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363537332C2273796E63223A313337373639343639302C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D5A48417048305854386B744E3B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A313220474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A313220474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
313120474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363537342C2273796E63223A313337373639343639322C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D306F614F316F746B6D45717A3B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A313420474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A313420474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
313320474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363537352C2273796E63223A313337373639343639342C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D4F52774C577951576B6B61513B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A313620474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A313620474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
313520474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363537392C2273796E63223A313337373639343639362C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D593763624A356864645561633B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A313820474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A313820474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
313820474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363538322C2273796E63223A313337373639343639382C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D6B586B74545235576C30326F3B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A323120474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A323120474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
323020474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363538342C2273796E63223A313337373639343730312C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D6C4431416A6C6E38553271723B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A323320474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A323320474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
323220474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363538342C2273796E63223A313337373639343730332C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D4D47627549795833574532513B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A323520474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A323520474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
323420474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363538362C2273796E63223A313337373639343730352C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D356A584265314250744547473B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A323720474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A323720474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
323620474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363538382C2273796E63223A313337373639343730372C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D7146383375545245573053693B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A333020474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A333020474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
323920474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363538392C2273796E63223A313337373639343731302C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D784E354D6873786B344557523B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A333220474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A333220474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
333120474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363539312C2273796E63223A313337373639343731322C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D53487554447043557549504B3B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A333420474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A333420474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
333320474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363539332C2273796E63223A313337373639343731342C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D6F4A7A497652564E335531423B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A333620474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A333620474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
333520474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363539332C2273796E63223A313337373639343731362C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D496D7371556D6F72306166643B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A333820474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A333820474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
333820474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363539372C2273796E63223A313337373639343731382C22
6D73223A317D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D77426E79467774584D3065753B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A343120474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A343120474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
343020474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363539392C2273796E63223A313337373639343732312C22
6D73223A307D
} spec: make object! [
    title: "TCP Networking"
    scheme: 'tcp
    ref: tcp://chat.stackoverflow.com:80
    path: none
    host: "chat.stackoverflow.com"
    port-id: 80
]
scheme: make object! [
    name: 'tcp
    title: "TCP Networking"
    spec: make object! [
        title: none
        scheme: none
        ref: none
        path: none
        host: none
        port-id: 80
    ]
    info: make object! [
        local-ip: none
        local-port: none
        remote-ip: none
        remote-port: none
    ]
    actor: make native! [[port!]]
    awake: make function! [[event][print ['TCP-event event/type] true]]
]
actor: make native! [[port!]]
awake: make function! [[event /local result messages content message-no message-id data json user-name message-rule parent-id person-id timestamp][
    timestamp:
    person-id:
    message-id:
    parent-id: 0
    user-name: make string! 20
    message-rule: [
        <event_type> quote 1 |
        <time_stamp> set timestamp integer! |
        <content> set content string! |
        <id> integer! |
        <user_id> set person-id integer! |
        <user_name> set user-name string! |
        <room_id> integer! |
        <room_name> string! |
        <message_id> set message-id integer! |
        <parent_id> set parent-id integer! |
        <show_parent> logic! |
        tag! skip |
        end
    ]
    switch/default event/type [
        lookup [open event/port false]
        connect [
            write event/port #{
504F5354202F63686174732F3239312F6576656E747320485454502F312E300A
486F73743A20636861742E737461636B6F766572666C6F772E636F6D0A557365
722D4167656E743A204D6F7A696C6C612F352E300A4163636570743A202A2F2A
0A4163636570742D4C616E67756167653A20656E2D55532C656E3B713D302E35
0A4163636570742D456E636F64696E673A20677A69702C206465666C6174650A
444E543A20310A436F6E74656E742D547970653A206170706C69636174696F6E
2F782D7777772D666F726D2D75726C656E636F6465643B20636861727365743D
5554462D380A582D5265717565737465642D576974683A20584D4C4874747052
6571756573740A526566657265723A20687474703A2F2F636861742E73746163
6B6F766572666C6F772E636F6D0A436F6E74656E742D4C656E6774683A203730
0A436F6F6B69653A206373723D743D4C494249424D58414445325A3B205F5F75
746D613D3134303032393535332E323033393430333434362E31333737343832
3833382E313337373438323833382E313337373438353535342E323B205F5F75
746D7A3D3134303032393535332E313337373438323833382E312E312E75746D
6373723D28646972656374297C75746D63636E3D28646972656374297C75746D
636D643D286E6F6E65293B205F5F7163613D50302D313136363636373939372D
313337373438323833373630323B207573723D743D6F554B7577774A376C5557
7426733D5446355031565953776B32490A0A73696E63653D30266D6F64653D4D
65737361676573266D7367436F756E743D3526666B65793D6234343563626435
376636663837363664376166383733396634336139306537
}
            event/port/locals: copy #{}
            false
        ]
        wrote [read event/port false]
        read [
            append event/port/locals event/port/data
            clear event/port/data
            read event/port
            false
        ]
        close done [
            if event/port/data [
                append event/port/locals event/port/data
            ]
            result: to string! event/port/locals
            if parse result [thru "^/^/" copy result to end] [
                if json: load-json/flat result [
                    messages: json/2
                    len: length? system/contexts/user/all-messages
                    print now
                    foreach msg messages [
                        content: none
                        user-name: none
                        message-id: 0
                        either parse msg [some message-rule] [
                            content: trim decode-xml content
                            ?? message-id
                            if all [
                                integer? message-id
                                not exists? join storage-dir message-id
                            ] [
                                write join storage-dir message-id mold msg
                            ]
                            if message-id > lastmessage-no [
                                set 'lastmessage-no message-id
                                repend/only system/contexts/user/all-messages [person-id message-id user-name content timestamp]
                            ]
                        ] [print ["failed parse" msg]]
                    ]
                ]
            ]
            true
        ]
    ] [true]
]]
state: #{}
data: #{}
locals: #{
485454502F312E3120323030204F4B0D0A43616368652D436F6E74726F6C3A20
6E6F2D63616368650D0A507261676D613A206E6F2D63616368650D0A436F6E74
656E742D547970653A206170706C69636174696F6E2F6A736F6E3B2063686172
7365743D7574662D380D0A457870697265733A202D310D0A5365742D436F6F6B
69653A206373723D743D56386E376F7247614B5557693B20657870697265733D
4672692C2032382D4665622D323031342031323A35383A343320474D543B2070
6174683D2F3B20487474704F6E6C790D0A5365742D436F6F6B69653A202E4153
505842726F777365724F766572726964653D3B20657870697265733D5475652C
2032372D4175672D323031332031323A35383A343320474D543B20706174683D
2F0D0A446174653A205765642C2032382041756720323031332031323A35383A
343220474D540D0A436F6E6E656374696F6E3A20636C6F73650D0A436F6E7465
6E742D4C656E6774683A20343330370D0A0D0A7B226576656E7473223A5B0D0A
7B226576656E745F74797065223A312C2274696D655F7374616D70223A313337
373638393031312C22636F6E74656E74223A225C753030336364697620636C61
73733D5C226F6E65626F78206F622D706F73745C225C75303033655C75303033
6364697620636C6173733D5C226F622D706F73742D766F7465735C2220746974
6C653D5C2254686973207175657374696F6E2068617320612073636F7265206F
66202D312E5C225C75303033652D315C75303033632F6469765C75303033655C
7530303363696D672077696474683D5C2232305C22206865696768743D5C2232
305C2220636C6173733D5C226F622D706F73742D7369746569636F6E5C222073
72633D5C22687474703A2F2F63646E2E737374617469632E6E65742F73746163
6B6F766572666C6F772F696D672F6170706C652D746F7563682D69636F6E2E70
6E675C22207469746C653D5C22537461636B204F766572666C6F775C222F5C75
303033655C753030336364697620636C6173733D5C226F622D706F73742D7469
746C655C225C7530303365513A205C753030336361207374796C653D5C22636F
6C6F723A20233030373743433B5C2220687265663D5C22687474703A2F2F7374
61636B6F766572666C6F772E636F6D2F7175657374696F6E732F313834383631
33312F77696C6C2D7265642D7265626F6C2D737570706F72742D74656C2D696E
2D7468652D6675747572655C225C753030336557696C6C205265642F5245424F
4C20737570706F72742054454C2120696E20746865206675747572653F5C7530
3033632F615C75303033655C75303033632F6469765C75303033655C75303033
637020636C6173733D5C226F622D706F73742D626F64795C225C75303033655C
7530303363696D672077696474683D5C2233325C22206865696768743D5C2233
325C2220636C6173733D5C22757365722D677261766174617233325C22207372
633D5C2268747470733A2F2F7777772E67726176617461722E636F6D2F617661
7461722F37386662356138326334376634366663306565306337656537313536
366162383F733D3132385C7530303236616D703B643D6964656E7469636F6E5C
7530303236616D703B723D50475C7530303236616D703B663D315C2220746974
6C653D5C224A65727279547361695C2220616C743D5C224A6572727954736169
5C222F5C75303033655245424F4C20737570706F72747320454D41494C212C20
616E6420526564206D6967687420737570706F727420454D41494C2120746F6F
2E20496E20736F6D65206D6F62696C6520617070732C2074656C6570686F6E65
206E756D626572206973206D6F726520696D706F7274616E74207468616E2065
2D6D61696C2C20736F204920686F7065205265642F5245424F4C2077696C6C20
737570706F72742061206E65772064617461747970652054454C212C20616E64
206D616B652069742061206C69746572616C20747970652C2077686963682063
616E206265207265636F676E697A656420627920746F6B656E697A65722E2041
20666F726D6174206C696B65207468697320776F756C6420626520676F6F643A
202B3838362D3938383231303830302E20572E2E2E5C75303033632F705C7530
3033655C753030336364697620636C6173733D5C226F622D706F73742D746167
735C225C75303033655C75303033636120687265663D5C22687474703A2F2F73
7461636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765
642F74797065735C225C75303033655C75303033637370616E20636C6173733D
5C226F622D706F73742D7461675C22207374796C653D5C226261636B67726F75
6E642D636F6C6F723A20234530454146313B20636F6C6F723A20233345364438
453B20626F726465722D636F6C6F723A20233345364438453B20626F72646572
2D7374796C653A20736F6C69643B5C225C753030336574797065735C75303033
632F7370616E5C75303033655C75303033632F615C7530303365205C75303033
636120687265663D5C22687474703A2F2F737461636B6F766572666C6F772E63
6F6D2F7175657374696F6E732F7461676765642F7265626F6C5C225C75303033
655C75303033637370616E20636C6173733D5C226F622D706F73742D7461675C
22207374796C653D5C226261636B67726F756E642D636F6C6F723A2023453045
4146313B20636F6C6F723A20233345364438453B20626F726465722D636F6C6F
723A20233345364438453B20626F726465722D7374796C653A20736F6C69643B
5C225C75303033657265626F6C5C75303033632F7370616E5C75303033655C75
303033632F615C7530303365205C75303033636120687265663D5C2268747470
3A2F2F737461636B6F766572666C6F772E636F6D2F7175657374696F6E732F74
61676765642F74656C6570686F6E655C225C75303033655C7530303363737061
6E20636C6173733D5C226F622D706F73742D7461675C22207374796C653D5C22
6261636B67726F756E642D636F6C6F723A20234530454146313B20636F6C6F72
3A20233345364438453B20626F726465722D636F6C6F723A2023334536443845
3B20626F726465722D7374796C653A20736F6C69643B5C225C75303033657465
6C6570686F6E655C75303033632F7370616E5C75303033655C75303033632F61
5C7530303365205C75303033636120687265663D5C22687474703A2F2F737461
636B6F766572666C6F772E636F6D2F7175657374696F6E732F7461676765642F
7265645C225C75303033655C75303033637370616E20636C6173733D5C226F62
2D706F73742D7461675C22207374796C653D5C226261636B67726F756E642D63
6F6C6F723A20234530454146313B20636F6C6F723A20233345364438453B2062
6F726465722D636F6C6F723A20233345364438453B20626F726465722D737479
6C653A20736F6C69643B5C225C75303033657265645C75303033632F7370616E
5C75303033655C75303033632F615C75303033655C75303033632F6469765C75
303033655C753030336364697620636C6173733D5C22636C6561722D626F7468
5C225C75303033655C75303033632F6469765C75303033655C75303033632F64
69765C7530303365222C22757365725F6964223A2D322C22757365725F6E616D
65223A224665656473222C22726F6F6D5F6964223A3239312C226D6573736167
655F6964223A31313438333130327D2C0D0A7B226576656E745F74797065223A
312C2274696D655F7374616D70223A313337373639313733332C22636F6E7465
6E74223A224A65727279206A75737420747269656420746F206A6F696E20534F
206368617420627920706F7374696E6720746865207175657374696F6E206162
6F76652C20776869636820676F7420696D6D6564696174656C7920646F776E76
6F7465642C206D616B696E67204A657272792067697665207570206F6E206A6F
696E696E672075732E2E2E77656C6C20646F6E65212121222C22757365725F69
64223A323032363538322C22757365725F6E616D65223A22446F634B696D6265
6C222C22726F6F6D5F6964223A3239312C226D6573736167655F6964223A3131
3438343031332C226D6573736167655F7374617273223A312C226D6573736167
655F6F776E65725F7374617273223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323132372C22636F6E
74656E74223A2240446F634B696D62656C202D20746861742069732062656361
75736520534F2069732064726976656E206279206B696E64206F662070657273
6F6E732C2077686F207468696E6B2074686174207374726963746C7920616468
6572696E6720746F20736F6D652072756C65732C2077696C6C206B6565702074
686569722073797374656D2077656C6C2073657276696E672069747320707572
706F73652C20666F7267657474696E6720746F20666F6C6C6F77207468652072
6571756972656D656E7473206F6620697473207573657262617365202E2E2E22
2C22757365725F6964223A323037373837372C22757365725F6E616D65223A22
70656B72222C22726F6F6D5F6964223A3239312C226D6573736167655F696422
3A31313438343138372C22706172656E745F6964223A31313438343031332C22
6D6573736167655F6564697473223A317D2C0D0A7B226576656E745F74797065
223A312C2274696D655F7374616D70223A313337373639323236372C22636F6E
74656E74223A225C753030336364697620636C6173733D5C226F6E65626F7820
6F622D626C6F675C225C75303033655C753030336364697620636C6173733D5C
226F622D626C6F672D7469746C655C225C75303033655C753030336361206872
65663D5C2268747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265
626F6C2F70756C6C2F3133395C225C753030336550756C6C2052657175657374
7320285233293A20436C6F6E6523313836335C75303033632F615C7530303365
5C75303033632F6469765C75303033655C753030336364697620636C6173733D
5C226F622D626C6F672D6D6574615C225C7530303365706F73746564206F6E20
4175677573742032382C2032303133206279206C616469736C61765C75303033
632F6469765C75303033655C753030336364697620636C6173733D5C226F622D
626C6F672D746578745C225C75303033655C7530303363705C75303033654261
736564206F6E2070756C6C20233133382E205265736F6C766573204343233138
36332E2054657374656420696E204C696E75782028302E342E34295C75303033
632F705C75303033655C75303033632F6469765C75303033655C75303033632F
6469765C7530303365222C22757365725F6964223A2D322C22757365725F6E61
6D65223A224665656473222C22726F6F6D5F6964223A3239312C226D65737361
67655F6964223A31313438343235327D2C0D0A7B226576656E745F7479706522
3A312C2274696D655F7374616D70223A313337373639333839362C22636F6E74
656E74223A225C753030336364697620636C6173733D5C226F6E65626F78206F
622D626C6F675C225C75303033655C753030336364697620636C6173733D5C22
6F622D626C6F672D7469746C655C225C75303033655C75303033636120687265
663D5C22687474703A2F2F63757265636F64652E6F72672F7265626F6C332F74
69636B65742E7273703F69643D3138363323636F6D6D656E74735C225C753030
336543757265436F64653A204D414B45206F626A656374206F626A6563742064
6F65736E5C75303032362333393B7420726562696E642066756E6374696F6E73
5C75303033632F615C75303033655C75303033632F6469765C75303033655C75
3030336364697620636C6173733D5C226F622D626C6F672D6D6574615C225C75
30303365706F73746564206F6E204175677573742032382C2032303133206279
204C616469736C61765C75303033632F6469765C75303033655C753030336364
697620636C6173733D5C226F622D626C6F672D746578745C225C75303033655C
7530303363705C75303033655B436F6D6D656E745D2046697865642062792068
747470733A2F2F6769746875622E636F6D2F7265626F6C2F7265626F6C2F7075
6C6C2F3133395C75303033632F705C75303033655C75303033632F6469765C75
303033655C75303033632F6469765C7530303365222C22757365725F6964223A
2D322C22757365725F6E616D65223A224665656473222C22726F6F6D5F696422
3A3239312C226D6573736167655F6964223A31313438343834307D5D2C227469
6D65223A32323832363630312C2273796E63223A313337373639343732332C22
6D73223A317D
}]