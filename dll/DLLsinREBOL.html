<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><style type="text/css">@media screen { h1,h2,h3,h4,h5,p,a,br,li,td, .underline {font-family:Arial, Helvetica, sans-serif;text-align:justify} hr {text-align:center} p,table {margin-left: 10px;margin-right:10px} .defword {white-space:nowrap} .deftable {border-style:none;vertical-align:top} .deftablefaq {border-style:solid;border-width:thin} .end {font-size:8pt} .example {margin-left:50px;margin-right:50px;border:2px solid;padding: 10px;background-color:#EEEEEE} .header {margin-left:50px;margin-right:50px;border:2px solid;padding: 10px;background-color:yellow} .indented {margin-left: 50px} .litable {text-align:left} .new {border-right: 10px solid; padding-right: 10px; font-family:Arial} .note {margin-left:50px;margin-right:50px;border:2px solid;padding: 10px;background-color:#F0F0D0} .tocindent {margin-left: 20px} .top {font-size:8pt;text-align:right} .underline {text-decoration:underline} } @media print { h1,h2,h3,h4,h5,p,a,br,li, #underline {font-family:Arial;text-align:justify;orphans:5;widows:5} p,li,td {font-size:10pt} ul,ol {page-break-after:avoid;orphans:5;widows:5} }</style><title>Creating and Using DLL's for REBOL</title></head><body><a id="top" name="top"></a><h2>Creating and Using DLL's for REBOL</h2><pre class="header"><strong>    Author: Josh Shireman
    Date: October 14, 2004</strong></pre><h2><a id="sect1" name="sect1">1. Introduction</a></h2><p>This tutorials will target people with some experience with C who want to play arount with DLL's with REBOL.  I will be discussing DLL creation using Dev-C++, so if you use something else, you can write a tutorial for it.   Other than that, this document focuses on a quick start to DLL usage in REBOL.</p><div class="top">[ <a href="#top">back to top</a> ]</div><hr /><h2><a id="sect2" name="sect2">2. Creating a DLL</a></h2><h3><a id="sect2.1" name="sect2.1">2.1 Getting Dev-C++</a></h3><p>The first step is to download Dev-C++ from</p><p><a href="http://www.bloodshed.net/devcpp.html">Bloodshed.net</a></p><p>Proceed with a basic installation and there you go.</p><h3><a id="sect2.2" name="sect2.2">2.2 Setting up a new DLL project</a></h3><p>First go to the File -> New -> Project.</p><p style="text-align:center"><img src="tut1.gif"></img></p><p>A box will pop up onscreen with five project types and options for C or C++.  Select DLL and "C project".  Type "test" as the project name.  Click Ok. </p><p style="text-align:center"><img src="tut2.gif"></img></p><p>When the file requestor pops up, create a directory "test" and save the test.dev project inside.  Dev-C++ will automatically create for you two files:  dllmain.c and dll.h .  These files will make up your first DLL. </p><h3><a id="sect2.3" name="sect2.3">2.3 Compiling</a></h3><p style="text-align:center"><img src="tut3.gif"></img></p><p>Press the Compile button.  You now have a DLL named "test.dll".  Yes, it was that easy.  Now, for the fun part!  Lets play around with it in rebol!</p><div class="top">[ <a href="#top">back to top</a> ]</div><hr /><h2><a id="sect3" name="sect3">3. Basic DLL's in REBOL</a></h2><p>REBOL needs a /PRO key in order to use DLL's.</p><h3><a id="sect3.1" name="sect3.1">3.1 Loading a library in REBOL</a></h3><p>Make sure the script is in the correct directory.  Loading a library is very simple.  Just use load/library .</p><pre class="example">    change-directory %/j/dev-cpp/test/
    test-dll: load/library %test.dll</pre><p>Now we can access the functions within the dll.</p><h3><a id="sect3.2" name="sect3.2">3.2 Time to break into a routine!</a></h3><p>Rebol uses routines to access the DLL.  Take a look at the C code from dllmain.c:</p><pre class="example">    DLLIMPORT void HelloWorld ()
    {
        MessageBox (0, "Hello World from DLL!\n", "Hi", MB_ICONINFORMATION);
    }</pre><p>We need to three things about a function to use it in REBOL: name, arguments, and return value.  So, the function name is "HelloWorld".  We will use this to call it from the library.  Here is the code:</p><pre class="example">    hw: make routine! [] test-dll "HelloWorld"</pre><p>Since HelloWorld takes no arguments nor returns a value, the block is left empty.  Now, when you call hw, REBOL will run HelloWorld from the DLL. Good, it is time to use it.  Type the name:</p><pre class="example">    hw</pre><p>And you will get a pop up box!</p><div class="top">[ <a href="#top">back to top</a> ]</div><hr /><h2><a id="sect4" name="sect4">4. A step higher in complexity</a></h2><h3><a id="sect4.1" name="sect4.1">4.1 The C code</a></h3><p>Now, we will discuss handling arguments and return values.  In the file dllmain.c , add this function:</p><pre class="example">    DLLIMPORT int Square (int x)
    {
        return x * x;
    }</pre><p>Now recompile, and your DLL includes this function.</p><h3><a id="sect4.2" name="sect4.2">4.2 In REBOL</a></h3><p>Next, when we define the routine! for this C function, we need to set the arguments and return for the function.   The argument for Square is of C type int, which is an integer! in REBOL.  Since the return value is the int x * x also, it will return an integer!.  The routine! will be:</p><pre class="example">    square: make routine! [
        x [integer!]
        return: [integer!]
    ] test-dll "Square"</pre><p>You can now square numbers until you are content. </p><h3><a id="sect4.3" name="sect4.3">4.3 Concerns</a></h3><p>For simple functions such as these, I do not recommend using a DLL because overhead will be very high.  Here is a simple benchmark:</p><pre class="example">    change-dir %/j/dev-cpp/test/
    b: load/library %test.dll

    square: make routine! [
        x [integer!] 
        return: [integer!]
    ] b "Square"

    sq: func [
        x [integer!]
    ] [x * x]

    a: now/time/precise
    repeat i 100000 [square 5]
    b: (now/time/precise - a)

    a: now/time/precise
    repeat i 100000 [sq 5]
    c: (now/time/precise - a)

    print ["Library Square Function: " b] 
    print ["Rebol Square Function: " c] </pre><p>And the results of the benchmark follow.  As you can see, the native REBOL code is approximately 8 times faster than using the DLL.</p><pre class="example">    Library Square Function:  0:00:00.581
    Rebol Square Function:  0:00:00.07</pre><p>Okay, now that we have seen some simple examples, I will discuss more general DLL creation/access</p><div class="top">[ <a href="#top">back to top</a> ]</div><hr /><h2><a id="sect5" name="sect5">5. DLL's in C</a></h2><p>As far as I know, you create C code for DLL's in the same way you write any functions in C.   Just include them similarly to the way the above examples were included.  NOTE: At the present step in the tutorial, the dll.h header file does not include anything necessary for compilation. </p><div class="top">[ <a href="#top">back to top</a> ]</div><hr /><h2><a id="sect6" name="sect6">6. Acessing DLL's in REBOL</a></h2><p>For routine! declaration, there are many types in C that have similar types in REBOL:</p><ul><li>char! - can be used to represent char in C.</li><li>short -</li><li>integer! -</li><li>int -</li><li>long -</li><li>struct - (NOTE: will cover in more detail later.)</li><li>float -</li><li>decimal! -</li><li>binary! -</li></ul><div class="top">[ <a href="#top">back to top</a> ]</div><hr /><p class="end">Document formatter copyright <a href="http://www.robertmuench.de">Robert M. Münch</a>. All Rights Reserved.<br />XHTML 1.0 Transitional formatted with Make-Doc-Pro Version:1.0.8 on 14-Oct-2004 at 14:43:57</p></body></html>